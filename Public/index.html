<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Notes</title>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f5f5f5;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        /* ========== BENTO GRID LAYOUT ========== */
        
        .bento-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ========== STICKY HEADER ========== */
        .bento-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: white;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        /* Top Bar with Logo & Settings */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 1.8em;
        }

        .logo-text h1 {
            font-size: 1.3em;
            font-weight: 700;
            line-height: 1;
        }

        .logo-text .tagline {
            font-size: 0.75em;
            opacity: 0.9;
            margin-top: 2px;
        }

        .settings-icon {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            font-size: 1.4em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .settings-icon:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        /* Status Banner */
        .status-banner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e0;
            transition: background 0.3s;
        }

        .status-dot.ready { background: #48bb78; }
        .status-dot.listening { background: #4299e1; animation: pulse 2s infinite; }
        .status-dot.analyzing { background: #fbbf24; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .status-text {
            font-weight: 600;
            color: #2d3748;
        }

        .audio-source {
            font-size: 0.85em;
            color: #718096;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Control Buttons */
        .control-buttons {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 8px;
            padding: 12px 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }

        .btn {
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-start { background: #48bb78; color: white; }
        .btn-stop { background: #e53e3e; color: white; }
        .btn-save { background: #667eea; color: white; }
        .btn-clear { background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; }

        /* Live Transcript */
        .live-transcript {
            padding: 12px 20px;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            max-height: 80px;
            overflow-y: auto;
        }

        .transcript-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #a0aec0;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .transcript-text {
            font-size: 0.85em;
            color: #2d3748;
            line-height: 1.5;
            font-style: italic;
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            background: white;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .quick-btn {
            padding: 8px 16px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .quick-btn:active {
            transform: scale(0.95);
            background: #e2e8f0;
        }

        /* ========== MAIN CONTENT AREA ========== */
        .bento-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        /* ========== BENTO GRID ========== */
        .field-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }

        /* Landscape mode: 2 columns */
        @media (min-width: 768px) and (orientation: landscape) {
            .field-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Large screens: 3 columns */
        @media (min-width: 1200px) {
            .field-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Field Card */
        .field-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .field-card:active {
            transform: scale(0.98);
        }

        .field-card.updated {
            border-color: #48bb78;
            animation: cardPulse 0.6s ease-out;
        }

        @keyframes cardPulse {
            0% { background: white; }
            50% { background: #f0fff4; }
            100% { background: white; }
        }

        .field-card.locked {
            background: #fffbeb;
            border-color: #fbbf24;
        }

        .field-card.collapsed .field-content {
            display: none;
        }

        /* Update Badge */
        .update-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            background: #48bb78;
            color: white;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.65em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .field-card.updated .update-badge {
            opacity: 1;
        }

        /* Field Header */
        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .field-info {
            flex: 1;
        }

        .field-name {
            font-size: 1.05em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .field-hint {
            font-size: 0.8em;
            color: #a0aec0;
            font-style: italic;
            margin-top: 4px;
        }

        .empty-indicator {
            font-size: 0.7em;
            padding: 2px 8px;
            background: #fed7d7;
            color: #c53030;
            border-radius: 6px;
            font-weight: 600;
        }

        .has-content-indicator {
            font-size: 0.7em;
            padding: 2px 8px;
            background: #c6f6d5;
            color: #22543d;
            border-radius: 6px;
            font-weight: 600;
        }

        .field-actions {
            display: flex;
            gap: 6px;
            align-items: flex-start;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #f7fafc;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:active {
            transform: scale(0.9);
        }

        .icon-btn.collapse {
            background: #e2e8f0;
        }

        .icon-btn.lock {
            background: #fef5e7;
        }

        .icon-btn.delete {
            background: #fed7d7;
        }

        /* Field Content */
        .field-content {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .field-value {
            font-size: 0.9em;
            color: #4a5568;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .field-value:empty::before {
            content: 'Waiting for data...';
            color: #a0aec0;
            font-style: italic;
        }

        /* User Notes Section */
        .user-notes-card {
            background: linear-gradient(135deg, #fff5eb 0%, #ffe4cc 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }

        .user-notes-label {
            font-size: 1.1em;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-notes-input {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
            background: white;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2em;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            z-index: 50;
        }

        .fab:active {
            transform: scale(0.9);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #2d3748;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: #f7fafc;
            border-radius: 8px;
            font-size: 1.5em;
            cursor: pointer;
            color: #4a5568;
        }

        .add-field-form {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .add-field-input {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .add-field-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-add-field {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
        }

        /* Fullscreen Overlay */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 300;
            flex-direction: column;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .fullscreen-title {
            font-size: 1.3em;
            font-weight: 700;
        }

        .fullscreen-close {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 10px;
            font-size: 2em;
            cursor: pointer;
        }

        .fullscreen-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .fullscreen-hint {
            font-size: 0.9em;
            color: #718096;
            font-style: italic;
            margin-bottom: 20px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .fullscreen-value {
            font-size: 1em;
            color: #2d3748;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* Repository Section */
        .repository-section {
            margin-top: 24px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .repo-header {
            font-size: 1.2em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
        }

        .repo-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .repo-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
        }

        .view-history-btn {
            grid-column: 1 / -1;
            background: #2d3748;
            color: white;
            padding: 14px;
            font-size: 1em;
        }

        .note-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 10px;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .note-title {
            font-weight: 700;
            color: #667eea;
        }

        .note-date {
            font-size: 0.85em;
            color: #718096;
        }

        .note-preview {
            font-size: 0.9em;
            color: #4a5568;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .note-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .note-btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 700;
            cursor: pointer;
            color: white;
        }

        .history-container {
            display: none;
        }

        .history-container.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="bento-container">
        <!-- Header -->
        <div class="bento-header">
            <!-- Top Bar -->
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">üéôÔ∏è</div>
                    <div class="logo-text">
                        <h1>Bingo Notes</h1>
                        <div class="tagline">Intelligent Real-Time Notes</div>
                    </div>
                </div>
                <button class="settings-icon" id="settingsBtn">‚öôÔ∏è</button>
            </div>

            <!-- Status Banner -->
            <div class="status-banner">
                <div class="status-left">
                    <div class="status-dot ready" id="statusDot"></div>
                    <div class="status-text" id="statusText">Ready</div>
                </div>
                <div class="audio-source" id="audioSource">
                    üé§ Microphone
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="control-buttons">
                <button class="btn btn-start" id="startBtn">‚ñ∂Ô∏è Start</button>
                <button class="btn btn-stop" id="stopBtn" disabled>‚èπÔ∏è Stop</button>
                <button class="btn btn-save" id="saveBtn">üíæ Save</button>
                <button class="btn btn-clear" id="clearBtn">üóëÔ∏è Clear</button>
            </div>

            <!-- Live Transcript -->
            <div class="live-transcript">
                <div class="transcript-label">Live Transcript</div>
                <div class="transcript-text" id="transcriptText">Waiting for audio...</div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-btn" onclick="expandAll()">üìÇ Expand All</button>
                <button class="quick-btn" onclick="collapseAll()">üìÅ Collapse All</button>
                <button class="quick-btn" onclick="openTemplateManager()">üìã Templates</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bento-content">
            <!-- Field Grid -->
            <div class="field-grid" id="fieldGrid">
                <!-- Fields will be dynamically added here -->
            </div>

            <!-- User Notes -->
            <div class="user-notes-card">
                <div class="user-notes-label">
                    üìù User Notes
                    <span style="font-size: 0.7em; font-weight: 400; color: #92400e;">(Protected - AI won't modify)</span>
                </div>
                <textarea id="manualNotes" class="user-notes-input" placeholder="Add your own notes here. AI will not change this field."></textarea>
            </div>

            <!-- Repository Section -->
            <div class="repository-section">
                <div class="repo-header">üìö Saved Notes</div>
                <div class="repo-controls">
                    <button class="repo-btn" style="background: #4299e1; color: white;" id="shareAllBtn">üì§ Share All</button>
                    <button class="repo-btn" style="background: #e53e3e; color: white;" id="clearRepoBtn">üóëÔ∏è Clear All</button>
                </div>
                <button class="view-history-btn" id="viewHistoryBtn">Show Saved Notes</button>
                <div class="history-container" id="historyContainer"></div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button class="fab" onclick="openAddFieldModal()">+</button>
    </div>

    <!-- Add Field Modal -->
    <div class="modal-overlay" id="addFieldModal" onclick="closeAddFieldModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">‚ûï Add New Field</div>
                <button class="modal-close" onclick="closeAddFieldModal()">√ó</button>
            </div>
            <div class="add-field-form">
                <input type="text" class="add-field-input" id="fieldNameInput" placeholder="Field Name (e.g., Client Name)">
                <input type="text" class="add-field-input" id="fieldHintInput" placeholder="Extraction Hint (e.g., Extract full name)">
                <button class="btn-add-field" onclick="addNewField()">+ Add Field</button>
            </div>
        </div>
    </div>

    <!-- Template Manager Modal -->
    <div class="modal-overlay" id="templateModal" onclick="closeTemplateManager(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">üìã Template Manager</div>
                <button class="modal-close" onclick="closeTemplateManager()">√ó</button>
            </div>
            <div class="add-field-form">
                <select id="templateDropdown" class="add-field-input">
                    <option value="">-- Select Template --</option>
                </select>
                <button class="btn-add-field" onclick="loadTemplate()" style="background: #4299e1;">Load Template</button>
                <button class="btn-add-field" onclick="saveTemplate()" style="background: #48bb78;">Save Current as Template</button>
                <button class="btn-add-field" onclick="exportTemplate()" style="background: #718096;">Export Template</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTemplate()">
                <button class="btn-add-field" onclick="document.getElementById('importFile').click()" style="background: #718096;">Import Template</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Overlay -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fullscreen-header">
            <div class="fullscreen-title" id="fullscreenTitle">Field Name</div>
            <button class="fullscreen-close" onclick="closeFullscreen()">√ó</button>
        </div>
        <div class="fullscreen-content">
            <div class="fullscreen-hint" id="fullscreenHint">Extraction hint appears here</div>
            <div class="fullscreen-value" id="fullscreenValue">Content appears here</div>
        </div>
    </div>

    <script>
        // ========== GLOBAL VARIABLES ==========
        let currentWsUrl = localStorage.getItem('voice_app_ws_url') || 'wss://voice-assistant-4plp.onrender.com';
        
        let socket = null;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT = 3;

        let fields = [];
        let fullTranscript = '';

        // ========== UI ELEMENTS ==========
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const transcriptText = document.getElementById('transcriptText');
        const fieldGrid = document.getElementById('fieldGrid');
        const settingsBtn = document.getElementById('settingsBtn');

        // ========== SETTINGS ==========
        settingsBtn.addEventListener('click', () => {
            const newUrl = prompt("Enter Server WebSocket URL:", currentWsUrl);
            if (newUrl && newUrl.trim()) {
                currentWsUrl = newUrl.trim();
                localStorage.setItem('voice_app_ws_url', currentWsUrl);
                alert("Server URL Saved!");
            }
        });

        // ========== FIELD MANAGEMENT ==========
        function initDefaultFields() {
            if (fields.length === 0) {
                addField('Name', 'Extract the person\'s full name');
                addField('Date', 'Extract the date mentioned');
                addField('Summary', 'Brief summary of the conversation');
            }
        }

        function addField(name, hint) {
            const id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            if (fields.find(f => f.id === id)) return;
            
            fields.push({ id, name, hint, value: '', locked: false });
            renderField(id, name, hint);
            syncFieldsToServer();
        }

        function renderField(id, name, hint) {
            const field = fields.find(f => f.id === id);
            const isLocked = field?.locked || false;
            const hasContent = field?.value && field.value.trim().length > 0;
            
            const card = document.createElement('div');
            card.className = 'field-card';
            card.id = id;
            card.innerHTML = `
                <div class="update-badge">UPDATED</div>
                <div class="field-header" onclick="toggleCollapse(this)">
                    <div class="field-info">
                        <div class="field-name">
                            ${name}
                            <span class="${hasContent ? 'has-content-indicator' : 'empty-indicator'}">${hasContent ? '‚úì Has Data' : '‚ö† Empty'}</span>
                        </div>
                        <div class="field-hint">${hint}</div>
                    </div>
                    <div class="field-actions" onclick="event.stopPropagation()">
                        <button class="icon-btn collapse">‚ñº</button>
                        <button class="icon-btn" onclick="openFullscreen(this)" title="Fullscreen">‚õ∂</button>
                        <button class="icon-btn lock" onclick="toggleLock('${id}')">${isLocked ? 'üîí' : 'üîì'}</button>
                        <button class="icon-btn delete" onclick="deleteField('${id}')">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="field-content">
                    <div class="field-value" data-field-id="${id}">${field?.value || ''}</div>
                </div>
            `;
            
            fieldGrid.appendChild(card);
        }

        function updateFieldValue(fieldId, value) {
            const field = fields.find(f => f.id === fieldId);
            if (!field || field.locked) return;

            const cleanValue = (value === null || value === 'null') ? '' : value.trim();
            if (!cleanValue) return;

            field.value = cleanValue;

            const card = document.getElementById(fieldId);
            if (!card) return;

            const valueDiv = card.querySelector('.field-value');
            if (valueDiv) {
                valueDiv.textContent = field.value;
            }

            // Update indicator
            const indicator = card.querySelector('.empty-indicator, .has-content-indicator');
            if (indicator) {
                indicator.className = 'has-content-indicator';
                indicator.textContent = '‚úì Has Data';
            }

            // Trigger update animation
            card.classList.add('updated');
            setTimeout(() => card.classList.remove('updated'), 2000);
        }

        window.toggleCollapse = function(element) {
            const card = element.closest('.field-card');
            const collapseBtn = card.querySelector('.icon-btn.collapse');
            const isCollapsed = card.classList.toggle('collapsed');
            collapseBtn.textContent = isCollapsed ? '‚ñ∂' : '‚ñº';
        };

        window.toggleLock = function(id) {
            const field = fields.find(f => f.id === id);
            if (!field) return;
            
            field.locked = !field.locked;
            const card = document.getElementById(id);
            const lockBtn = card.querySelector('.icon-btn.lock');
            
            if (field.locked) {
                lockBtn.textContent = 'üîí';
                card.classList.add('locked');
            } else {
                lockBtn.textContent = 'üîì';
                card.classList.remove('locked');
            }
        };

        window.deleteField = function(id) {
            if (!confirm('Delete this field?')) return;
            fields = fields.filter(f => f.id !== id);
            document.getElementById(id).remove();
            syncFieldsToServer();
        };

        window.expandAll = function() {
            document.querySelectorAll('.field-card.collapsed').forEach(card => {
                card.classList.remove('collapsed');
                const collapseBtn = card.querySelector('.icon-btn.collapse');
                if (collapseBtn) collapseBtn.textContent = '‚ñº';
            });
        };

        window.collapseAll = function() {
            document.querySelectorAll('.field-card:not(.collapsed)').forEach(card => {
                card.classList.add('collapsed');
                const collapseBtn = card.querySelector('.icon-btn.collapse');
                if (collapseBtn) collapseBtn.textContent = '‚ñ∂';
            });
        };

        window.openFullscreen = function(btn) {
            const card = btn.closest('.field-card');
            const name = card.querySelector('.field-name').textContent.trim().split('\n')[0];
            const hint = card.querySelector('.field-hint').textContent;
            const value = card.querySelector('.field-value').textContent || 'No data yet';
            
            document.getElementById('fullscreenTitle').textContent = name;
            document.getElementById('fullscreenHint').textContent = hint;
            document.getElementById('fullscreenValue').textContent = value;
            document.getElementById('fullscreenOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.closeFullscreen = function() {
            document.getElementById('fullscreenOverlay').classList.remove('active');
            document.body.style.overflow = '';
        };

        // ========== ADD FIELD MODAL ==========
        window.openAddFieldModal = function() {
            document.getElementById('addFieldModal').classList.add('active');
            document.getElementById('fieldNameInput').focus();
        };

        window.closeAddFieldModal = function(event) {
            if (!event || event.target.id === 'addFieldModal') {
                document.getElementById('addFieldModal').classList.remove('active');
            }
        };

        window.addNewField = function() {
            const name = document.getElementById('fieldNameInput').value.trim();
            const hint = document.getElementById('fieldHintInput').value.trim();
            
            if (!name) {
                alert('Please enter a field name');
                return;
            }
            
            addField(name, hint || 'Extract relevant information');
            
            document.getElementById('fieldNameInput').value = '';
            document.getElementById('fieldHintInput').value = '';
            closeAddFieldModal();
        };

        // ========== TEMPLATE MANAGER ==========
        function initTemplates() {
            const stored = JSON.parse(localStorage.getItem('voice_templates') || '{}');
            
            const franchiseTemplate = [{"name":"Franchise Name","hint":"Extract full name."},{"name":"Industry","hint":"The company's industry and all details about the general industry"},{"name":"Investment Level","hint":"High and Low All-in Investment Range, Franchise Fees, Other setup costs"}];
            const businessOwnerTemplate = [{"name":"Company Name","hint":"Name of the owner's business"},{"name":"Owner's Name","hint":"Extract full name"},{"name":"Business Description","hint":"The industry, product or service, customers served"}];

            const defaults = {
                "Franchise Model": franchiseTemplate,
                "Business Owner": businessOwnerTemplate
            };
            
            Object.assign(stored, defaults);
            localStorage.setItem('voice_templates', JSON.stringify(stored));
            updateTemplateDropdown();
        }

        function updateTemplateDropdown() {
            const t = JSON.parse(localStorage.getItem('voice_templates')||'{}');
            const dropdown = document.getElementById('templateDropdown');
            dropdown.innerHTML = '<option value="">-- Select Template --</option>';
            Object.keys(t).forEach(n => {
                const o = document.createElement('option');
                o.value = n;
                o.innerText = n;
                dropdown.appendChild(o);
            });
        }

        window.openTemplateManager = function() {
            updateTemplateDropdown();
            document.getElementById('templateModal').classList.add('active');
        };

        window.closeTemplateManager = function(event) {
            if (!event || event.target.id === 'templateModal') {
                document.getElementById('templateModal').classList.remove('active');
            }
        };

        window.loadTemplate = function() {
            const name = document.getElementById('templateDropdown').value;
            if (!name) return;
            
            const t = JSON.parse(localStorage.getItem('voice_templates')||'{}')[name];
            if (t) {
                fields = [];
                fieldGrid.innerHTML = '';
                t.forEach(f => addField(f.name, f.hint));
                closeTemplateManager();
            }
        };

        window.saveTemplate = function() {
            const name = prompt('Template Name:');
            if (!name) return;
            
            const t = JSON.parse(localStorage.getItem('voice_templates')||'{}');
            t[name] = fields.map(f => ({name: f.name, hint: f.hint}));
            localStorage.setItem('voice_templates', JSON.stringify(t));
            updateTemplateDropdown();
            alert('Template saved!');
        };

        window.exportTemplate = function() {
            const template = fields.map(f => ({name: f.name, hint: f.hint}));
            const blob = new Blob([JSON.stringify(template, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template.json';
            a.click();
        };

        window.importTemplate = function() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const template = JSON.parse(e.target.result);
                    fields = [];
                    fieldGrid.innerHTML = '';
                    template.forEach(f => addField(f.name, f.hint));
                    closeTemplateManager();
                } catch(err) {
                    alert('Invalid template file');
                }
            };
            reader.readAsText(file);
        };

        // ========== WEBSOCKET & AUDIO ==========
        function syncFieldsToServer() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const templateData = fields.map(f => ({ 
                    id: f.id, 
                    name: f.name, 
                    hint: f.hint,
                    currentValue: f.value
                }));
                
                const userNotes = document.getElementById('manualNotes').value;

                socket.send(JSON.stringify({
                    type: 'contextUpdate',
                    fields: templateData,
                    userNotes: userNotes
                }));
            }
        }

        function convertFloat32ToPCM16(float32Array) {
            const pcm16 = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const s = Math.max(-1, Math.min(1, float32Array[i]));
                pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return pcm16;
        }

        function downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
            if (inputSampleRate === outputSampleRate) return buffer;
            const sampleRateRatio = inputSampleRate / outputSampleRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < result.length) {
                const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                let accum = 0;
                let count = 0;
                for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i];
                    count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++;
                offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        async function startListening() {
            if (!currentWsUrl) {
                alert("Please click Settings ‚öôÔ∏è to set your Server URL first.");
                settingsBtn.click();
                return;
            }
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true } 
                });

                socket = new WebSocket(currentWsUrl);
                
                socket.onopen = () => {
                    console.log('WebSocket connected');
                    statusDot.className = 'status-dot listening';
                    statusText.textContent = 'Listening...';
                    reconnectAttempts = 0;
                    syncFieldsToServer();
                    
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(mediaStream);
                    processor = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    processor.onaudioprocess = (e) => {
                        if (socket && socket.readyState === WebSocket.OPEN) {
                            const inputData = e.inputBuffer.getChannelData(0);
                            const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, 16000);
                            const pcm16 = convertFloat32ToPCM16(downsampled);
                            socket.send(pcm16.buffer);
                        }
                    };
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                };

                socket.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'status') {
                            statusDot.className = msg.active ? 'status-dot analyzing' : 'status-dot listening';
                            statusText.textContent = msg.active ? 'Analyzing...' : 'Listening...';
                        } else if (msg.type === 'transcript') {
                            transcriptText.textContent = msg.text;
                            if (msg.isFinal) fullTranscript += msg.text + '\n';
                        } else if (msg.type === 'templateUpdate' && msg.data) {
                            Object.keys(msg.data).forEach(key => updateFieldValue(key, msg.data[key]));
                        }
                    } catch (err) {
                        console.warn('Message error:', err);
                    }
                };

                socket.onerror = (error) => {
                    console.error('WS Error:', error);
                    statusText.textContent = 'Connection error';
                };
                
                socket.onclose = () => {
                    if (processor && mediaStream && mediaStream.active) {
                        if (reconnectAttempts < MAX_RECONNECT) {
                            reconnectAttempts++;
                            setTimeout(() => {
                                stopListening();
                                startListening();
                            }, 1000);
                        } else {
                            stopListening();
                            alert('Connection lost.');
                        }
                    }
                };
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                clearBtn.disabled = true;
                clearBtn.style.opacity = '0.5';
                
            } catch (err) {
                alert('Mic error: ' + err.message);
                stopListening();
            }
        }

        function stopListening() {
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
                audioContext = null;
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (socket) {
                if (socket.readyState === WebSocket.OPEN) socket.send('stop');
                socket.close();
                socket = null;
            }
            
            statusDot.className = 'status-dot ready';
            statusText.textContent = 'Ready';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            clearBtn.disabled = false;
            clearBtn.style.opacity = '1';
        }

        // ========== REPOSITORY ==========
        function generateNoteMarkdown(note) {
            let text = `# ${note.template || 'Bingo Note'}\n**Date:** ${note.date}\n\n`;
            note.fields.forEach(f => text += `## ${f.label}\n${f.value}\n\n`);
            return text;
        }

        function saveCurrentNote() {
            const noteData = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                template: "Current Session",
                fields: []
            };

            fields.forEach(f => {
                noteData.fields.push({
                    label: f.name,
                    value: f.value || ''
                });
            });

            const userNotes = document.getElementById('manualNotes').value;
            if (userNotes && userNotes.trim() !== "") {
                noteData.fields.push({ label: "üìù User Notes", value: userNotes });
            }
            
            if (fullTranscript && fullTranscript.trim() !== "") {
                noteData.fields.push({ label: "Full Transcript", value: fullTranscript });
            }

            const history = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]');
            history.unshift(noteData);
            localStorage.setItem('bingoNotesHistory', JSON.stringify(history));
            
            renderHistory();
            document.getElementById('historyContainer').classList.add('active');
            document.getElementById('viewHistoryBtn').innerText = "Hide Saved Notes";
            
            alert("Note Saved! ‚úÖ");
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]');
            const container = document.getElementById('historyContainer');
            container.innerHTML = '';

            if (history.length === 0) {
                container.innerHTML = '<p style="color:#777; text-align:center; padding:20px;">No saved notes yet.</p>';
                return;
            }

            history.forEach(note => {
                const card = document.createElement('div');
                card.className = "note-card";
                
                const contentPreview = note.fields.slice(0, 2).map(f => `<b>${f.label}:</b> ${f.value.substring(0, 50)}...`).join('<br>');
                
                card.innerHTML = `
                    <div class="note-header">
                        <div class="note-title">${note.template}</div>
                        <div class="note-date">${note.date}</div>
                    </div>
                    <div class="note-preview">${contentPreview}</div>
                    <div class="note-actions">
                        <button class="note-btn" style="background:#718096;" onclick="resumeNote(${note.id})">‚ñ∂Ô∏è Resume</button>
                        <button class="note-btn" style="background:#48bb78;" onclick="shareNote(${note.id})">üì§ Share</button>
                        <button class="note-btn" style="background:#4299e1;" onclick="copyNote(${note.id})">üìã Copy</button>
                        <button class="note-btn" style="background:#e53e3e;" onclick="deleteNote(${note.id})">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.resumeNote = function(id) {
            const history = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]');
            const note = history.find(n => n.id === id);
            if (!note) {
                alert("Note not found!");
                return;
            }
            
            if (!confirm(`Resume this note set from ${note.date}?`)) return;
            
            if (mediaStream && mediaStream.active) {
                stopListening();
            }
            
            fields = [];
            fieldGrid.innerHTML = '';
            
            note.fields.forEach(field => {
                if (field.label === "Full Transcript" || field.label === "üìù User Notes") return;
                
                const fieldId = field.label.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const hint = `Extract information about ${field.label}`;
                
                fields.push({ 
                    id: fieldId, 
                    name: field.label, 
                    hint: hint, 
                    value: field.value,
                    locked: false 
                });
                
                renderField(fieldId, field.label, hint);
            });
            
            const userNotesField = note.fields.find(f => f.label === "üìù User Notes");
            if (userNotesField) {
                document.getElementById('manualNotes').value = userNotesField.value;
            }
            
            const transcriptField = note.fields.find(f => f.label === "Full Transcript");
            if (transcriptField) {
                fullTranscript = transcriptField.value;
            }
            
            syncFieldsToServer();
            document.getElementById('historyContainer').classList.remove('active');
            document.getElementById('viewHistoryBtn').innerText = "Show Saved Notes";
            window.scrollTo(0, 0);
            
            alert(`‚úÖ Resumed note set from ${note.date}`);
        };

        window.shareNote = async function(id) {
            const note = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]').find(n => n.id === id);
            if (!note) return;
            const txt = generateNoteMarkdown(note);

            try {
                if (window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.Share) {
                    await Capacitor.Plugins.Share.share({
                        title: 'Bingo Note',
                        text: txt,
                        dialogTitle: 'Share Note'
                    });
                } else if (navigator.share) {
                    await navigator.share({ title: 'Bingo Note', text: txt });
                } else {
                    throw new Error("No share");
                }
            } catch(e) {
                await navigator.clipboard.writeText(txt);
                alert("Copied to clipboard! üìã");
            }
        };

        async function shareAllNotes() {
            const history = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]');
            if (history.length === 0) {
                alert("No notes to share!");
                return;
            }

            let fullContent = "# Bingo Notes Archive\n\n";
            history.forEach(note => {
                fullContent += generateNoteMarkdown(note) + "\n---\n\n";
            });

            try {
                if (window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.Share) {
                    await Capacitor.Plugins.Share.share({
                        title: 'Bingo Archive',
                        text: fullContent,
                        dialogTitle: 'Share Archive'
                    });
                } else if (navigator.share) {
                    await navigator.share({ title: 'Bingo Archive', text: fullContent });
                } else {
                    throw new Error("No Share");
                }
            } catch(e) {
                await navigator.clipboard.writeText(fullContent);
                alert("Archive copied to clipboard! üìã");
            }
        }

        window.copyNote = async function(id) {
            const note = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]').find(n => n.id === id);
            if (!note) return;
            await navigator.clipboard.writeText(generateNoteMarkdown(note));
            alert("Copied to clipboard! üìã");
        };

        window.deleteNote = function(id) {
            if (!confirm("Delete this note?")) return;
            let history = JSON.parse(localStorage.getItem('bingoNotesHistory') || '[]');
            history = history.filter(n => n.id !== id);
            localStorage.setItem('bingoNotesHistory', JSON.stringify(history));
            renderHistory();
        };

        // ========== EVENT LISTENERS ==========
        startBtn.addEventListener('click', startListening);
        stopBtn.addEventListener('click', stopListening);
        saveBtn.addEventListener('click', saveCurrentNote);
        
        clearBtn.addEventListener('click', () => {
            if (mediaStream && mediaStream.active) {
                alert('Please stop listening before clearing data.');
                return;
            }
            
            if (!confirm('Clear all current form data?')) return;
            
            fields.forEach(f => f.value = '');
            fieldGrid.querySelectorAll('.field-value').forEach(el => el.textContent = '');
            document.getElementById('manualNotes').value = '';
            transcriptText.textContent = 'Waiting for audio...';
            fullTranscript = '';
            
            // Update all indicators
            fieldGrid.querySelectorAll('.has-content-indicator, .empty-indicator').forEach(badge => {
                badge.className = 'empty-indicator';
                badge.textContent = '‚ö† Empty';
            });
        });

        document.getElementById('shareAllBtn').addEventListener('click', shareAllNotes);
        
        document.getElementById('clearRepoBtn').addEventListener('click', () => {
            if (confirm("Permanently delete ALL saved notes?")) {
                localStorage.removeItem('bingoNotesHistory');
                renderHistory();
            }
        });

        document.getElementById('viewHistoryBtn').addEventListener('click', () => {
            const container = document.getElementById('historyContainer');
            const btn = document.getElementById('viewHistoryBtn');
            
            if (container.classList.contains('active')) {
                container.classList.remove('active');
                btn.innerText = "Show Saved Notes";
            } else {
                container.classList.add('active');
                btn.innerText = "Hide Saved Notes";
                renderHistory();
            }
        });

        // ========== INITIALIZATION ==========
        initDefaultFields();
        initTemplates();
        renderHistory();

        // Sync on user notes change
        document.getElementById('manualNotes').addEventListener('input', () => {
            clearTimeout(window.noteSyncTimer);
            window.noteSyncTimer = setTimeout(syncFieldsToServer, 5000);
        });

        console.log('%cüéôÔ∏è Bingo Notes Ready!', 'color: #667eea; font-size: 16px; font-weight: bold;');
    </script>
</body>
</html>
