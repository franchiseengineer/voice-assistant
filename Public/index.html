<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Notes</title>
    <style>
        /* --- [PRESERVED UI STYLES FROM YOUR FILE] --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; touch-action: manipulation; overflow-x: hidden; }
        
        /* Layout & Header */
        .bento-container { width: 100%; min-height: 100vh; display: flex; flex-direction: column; }
        .bento-header { position: sticky; top: 0; z-index: 100; background: white; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .header-top { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo-icon { font-size: 1.8em; }
        .logo-text h1 { font-size: 1.3em; font-weight: 700; line-height: 1; }
        .logo-text .tagline { font-size: 0.75em; opacity: 0.9; margin-top: 2px; }
        .settings-icon { background: rgba(255,255,255,0.2); border: none; color: white; width: 44px; height: 44px; border-radius: 10px; font-size: 1.4em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        
        /* Template Bar */
        .template-bar { background: white; border-bottom: 2px solid #e2e8f0; padding: 12px 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .template-selector { flex: 1; min-width: 200px; }
        .template-select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95em; font-weight: 600; color: #2d3748; background: white; cursor: pointer; }
        .template-actions { display: flex; gap: 8px; }
        .template-btn { padding: 10px 16px; border: 2px solid #e2e8f0; border-radius: 8px; background: white; font-size: 0.85em; font-weight: 600; color: #4a5568; cursor: pointer; }
        .template-btn.primary { background: #667eea; color: white; border-color: #667eea; }

        /* Status & Controls */
        .status-banner { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .status-left { display: flex; align-items: center; gap: 10px; font-size: 0.9em; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #cbd5e0; transition: background 0.3s; }
        .status-dot.ready { background: #48bb78; }
        .status-dot.recording { background: #4299e1; animation: pulse 2s infinite; }
        .status-dot.analyzing { background: #fbbf24; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.1); } }
        
        .control-buttons { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; padding: 12px 20px; background: white; border-bottom: 1px solid #e2e8f0; }
        .btn { padding: 12px 8px; border: none; border-radius: 10px; font-size: 0.9em; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-start { background: #48bb78; color: white; }
        .btn-stop { background: #e53e3e; color: white; }
        .btn-save { background: #667eea; color: white; position: relative; }
        .btn-clear { background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; }

        /* Live Transcript */
        .live-transcript { padding: 12px 20px; background: white; border-bottom: 2px solid #e2e8f0; max-height: 80px; overflow-y: auto; }
        .transcript-text { font-size: 0.85em; color: #2d3748; line-height: 1.5; font-style: italic; }

        /* Bento Grid Content */
        .bento-content { flex: 1; padding: 16px; overflow-y: auto; }
        .field-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
        @media (min-width: 600px) { .field-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .bento-container { max-width: 1400px; margin: 0 auto; } .field-grid { grid-template-columns: repeat(4, 1fr); gap: 16px; } .bento-content { padding: 24px; } }

        /* Field Cards */
        .field-card { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 16px; transition: all 0.3s; position: relative; overflow: hidden; }
        .field-card.updated { border-color: #48bb78; animation: cardPulse 0.6s ease-out; }
        @keyframes cardPulse { 0% { background: white; } 50% { background: #f0fff4; } 100% { background: white; } }
        
        .field-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; cursor: pointer; }
        .field-name { font-size: 1.05em; font-weight: 700; color: #2d3748; margin-bottom: 4px; }
        .field-hint { font-size: 0.8em; color: #a0aec0; font-style: italic; }
        .field-value { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 0.95em; color: #2d3748; line-height: 1.6; min-height: 60px; width: 100%; font-family: inherit; resize: none; max-height: 220px; overflow-y: auto; }
        .field-value:focus { outline: none; border-color: #667eea; background: white; }

        /* User Notes Special Styling */
        .user-notes-card { border-color: #fbd38d; background: #fffaf0; }
        .user-notes-card .field-name { color: #c05621; }
        .user-notes-card .field-value { border-color: #fbd38d; background: white; }

        /* Modals & Menus (Simplified for Merged Logic) */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        
        /* Toasts */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #2d3748; color: white; padding: 16px 24px; border-radius: 12px; display: none; align-items: center; gap: 12px; font-weight: 600; z-index: 2000; }
        .toast.active { display: flex; animation: toastSlideUp 0.3s ease-out; }
        @keyframes toastSlideUp { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    </style>
</head>
<body>
    <div class="bento-container">
        <!-- HEADER -->
        <div class="bento-header">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">üéôÔ∏è</div>
                    <div class="logo-text"><h1>Bingo Notes</h1><div class="tagline">Voice-powered insights</div></div>
                </div>
                <button class="settings-icon" id="settingsBtn">‚öôÔ∏è</button>
            </div>

            <!-- Template Bar -->
            <div class="template-bar">
                <div class="template-selector">
                    <select class="template-select" id="templateSelect"><option value="">Loading templates...</option></select>
                </div>
                <!-- Hidden inputs for logic compatibility -->
                <input type="hidden" id="manualNotes" value=""> 
            </div>

            <!-- Status -->
            <div class="status-banner">
                <div class="status-left">
                    <div class="status-dot ready" id="statusDot"></div>
                    <div class="status-text" id="statusText">Ready</div>
                </div>
                <div class="audio-source">üé§ Microphone</div>
            </div>

            <!-- Transcript -->
            <div class="live-transcript">
                <div class="transcript-text" id="transcriptText">Waiting for audio...</div>
            </div>

            <!-- Controls -->
            <div class="control-buttons">
                <button class="btn btn-start" id="startBtn">‚ñ∂ Start</button>
                <button class="btn btn-stop" id="stopBtn" disabled>‚èπ Stop</button>
                <button class="btn btn-save" id="saveBtn">üíæ Save</button>
                <button class="btn btn-clear" id="clearBtn">üóëÔ∏è Clear</button>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="bento-content">
            <div class="field-grid" id="fieldGrid"></div>
            
            <!-- Dedicated User Notes Section (Always present) -->
            <div style="margin-top: 20px;">
                <div class="field-card user-notes-card">
                    <div class="field-header">
                        <div class="field-name">üìù User Manual Notes</div>
                    </div>
                    <div class="field-content">
                        <textarea class="field-value" id="userNotesInput" placeholder="Type your private notes here... they are sent to the AI as context but not overwritten."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úì</span>
        <span id="toastMessage">Action completed</span>
    </div>

    <script>
        // --- 1. CONFIGURATION & STATE ---
        let currentWsUrl = localStorage.getItem('voice_app_ws_url') || 'wss://voice-assistant-4plp.onrender.com';
        let socket = null;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let currentTemplate = [];
        let fullTranscript = "";
        let syncTimer = null;

        // --- 2. TEMPLATE LIBRARY (From your new file) ---
        const DEFAULT_TEMPLATES = [
            {
                id: 'franchise-evaluation', name: 'Franchise Evaluation', category: 'Business',
                fields: [
                    { name: 'Franchise Name', hint: 'Extract full name of the franchise' },
                    { name: 'Investment Level', hint: 'High and Low All-in Range' },
                    { name: 'Target Customer', hint: 'Demographics and market' },
                    { name: 'Territory Rights', hint: 'Exclusive territory details' }
                ]
            },
            {
                id: 'sales-call', name: 'Sales Call', category: 'Business',
                fields: [
                    { name: 'Lead Name', hint: 'Contact person name' },
                    { name: 'Pain Points', hint: 'Current challenges and needs' },
                    { name: 'Budget', hint: 'Budget range or constraints' },
                    { name: 'Next Steps', hint: 'Follow-up actions' }
                ]
            },
            {
                id: 'medical-consultation', name: 'Medical Consultation', category: 'Medical',
                fields: [
                    { name: 'Patient Name', hint: 'Full patient name' },
                    { name: 'Symptoms', hint: 'All reported symptoms' },
                    { name: 'Diagnosis', hint: 'Clinical diagnosis' },
                    { name: 'Treatment Plan', hint: 'Recommended treatment' }
                ]
            }
        ];

        // --- 3. UI RENDERING LOGIC ---
        function initUI() {
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">-- Select Template --</option>';
            
            DEFAULT_TEMPLATES.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.text = t.name;
                select.appendChild(opt);
            });

            // Load default
            select.addEventListener('change', (e) => loadTemplate(e.target.value));
            
            // Settings
            document.getElementById('settingsBtn').addEventListener('click', () => {
                const newUrl = prompt("Server URL:", currentWsUrl);
                if(newUrl) {
                    currentWsUrl = newUrl;
                    localStorage.setItem('voice_app_ws_url', newUrl);
                }
            });
        }

        function loadTemplate(id) {
            const template = DEFAULT_TEMPLATES.find(t => t.id === id);
            if (!template) return;
            
            currentTemplate = template.fields.map(f => ({
                id: f.name.toLowerCase().replace(/[^a-z0-9]/g, '-'),
                name: f.name,
                hint: f.hint,
                value: ''
            }));

            renderGrid();
            syncFieldsToServer(); // Tell server about new fields
            showToast('‚úì', `Loaded: ${template.name}`);
        }

        function renderGrid() {
            const grid = document.getElementById('fieldGrid');
            grid.innerHTML = '';

            currentTemplate.forEach(field => {
                const card = document.createElement('div');
                card.className = 'field-card';
                card.id = `card-${field.id}`; // For easy updates
                
                card.innerHTML = `
                    <div class="field-header">
                        <div class="field-info">
                            <div class="field-name">${field.name}</div>
                            <div class="field-hint">${field.hint}</div>
                        </div>
                    </div>
                    <div class="field-content">
                        <textarea class="field-value" id="input-${field.id}" 
                            oninput="handleInput('${field.id}', this.value)">${field.value}</textarea>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function handleInput(id, value) {
            const field = currentTemplate.find(f => f.id === id);
            if (field) field.value = value;
            
            // Debounced Sync
            clearTimeout(syncTimer);
            syncTimer = setTimeout(syncFieldsToServer, 2000);
        }

        // --- 4. WEBSOCKET ENGINE (The Missing Piece) ---
        async function startListening() {
            if (!currentWsUrl) return alert("No Server URL configured");
            
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });

                socket = new WebSocket(currentWsUrl);
                
                socket.onopen = () => {
                    console.log('WS Connected');
                    updateStatus('listening');
                    syncFieldsToServer(); // Send template immediately on connect
                    
                    // Audio Pipeline
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(mediaStream);
                    processor = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    processor.onaudioprocess = (e) => {
                        if (socket.readyState === WebSocket.OPEN) {
                            const inputData = e.inputBuffer.getChannelData(0);
                            const downsampled = downsampleBuffer(inputData, audioContext.sampleRate, 16000);
                            socket.send(convertFloat32ToPCM16(downsampled));
                        }
                    };
                    
                    source.connect(processor);
                    processor.connect(audioContext.destination);
                };

                socket.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'transcript') {
                            document.getElementById('transcriptText').textContent = msg.text;
                            fullTranscript += msg.text + " ";
                        } else if (msg.type === 'templateUpdate') {
                            applyServerUpdates(msg.data);
                        } else if (msg.type === 'status') {
                            updateStatus(msg.active ? 'analyzing' : 'listening');
                        }
                    } catch (e) { console.error(e); }
                };

                socket.onclose = () => updateStatus('ready');
                
            } catch (err) {
                alert("Microphone Error: " + err.message);
                updateStatus('ready');
            }
        }

        function stopListening() {
            if (processor) { processor.disconnect(); processor = null; }
            if (audioContext) { audioContext.close(); audioContext = null; }
            if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
            if (socket) { socket.close(); socket = null; }
            updateStatus('ready');
        }

        function syncFieldsToServer() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const userNotes = document.getElementById('userNotesInput').value;
                
                // Format matches what server.js expects
                const payload = {
                    type: 'contextUpdate',
                    fields: currentTemplate.map(f => ({
                        id: f.id,
                        name: f.name,
                        hint: f.hint,
                        currentValue: f.value
                    })),
                    userNotes: userNotes
                };
                socket.send(JSON.stringify(payload));
            }
        }

        function applyServerUpdates(data) {
            Object.keys(data).forEach(fieldId => {
                const field = currentTemplate.find(f => f.id === fieldId);
                if (field) {
                    field.value = data[fieldId];
                    const input = document.getElementById(`input-${fieldId}`);
                    const card = document.getElementById(`card-${fieldId}`);
                    
                    if (input && document.activeElement !== input) {
                        input.value = field.value;
                        // Flash effect
                        card.classList.remove('updated');
                        void card.offsetWidth; // trigger reflow
                        card.classList.add('updated');
                    }
                }
            });
        }

        // --- 5. UTILITIES (Audio) ---
        function downsampleBuffer(buffer, sampleRate, outSampleRate) {
            if (sampleRate == outSampleRate) return buffer;
            if (sampleRate < outSampleRate) throw "downsampling rate show be smaller than original sample rate";
            var sampleRateRatio = sampleRate / outSampleRate;
            var newLength = Math.round(buffer.length / sampleRateRatio);
            var result = new Float32Array(newLength);
            var offsetResult = 0;
            var offsetBuffer = 0;
            while (offsetResult < result.length) {
                var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                var accum = 0, count = 0;
                for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                    accum += buffer[i]; count++;
                }
                result[offsetResult] = accum / count;
                offsetResult++; offsetBuffer = nextOffsetBuffer;
            }
            return result;
        }

        function convertFloat32ToPCM16(buffer) {
            var l = buffer.length;
            var buf = new Int16Array(l);
            while (l--) {
                buf[l] = Math.min(1, buffer[l]) * 0x7FFF;
            }
            return buf.buffer;
        }

        function updateStatus(state) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const clearBtn = document.getElementById('clearBtn');

            dot.className = 'status-dot';
            
            if (state === 'listening') {
                dot.classList.add('recording');
                text.textContent = 'Listening...';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                clearBtn.disabled = true; // Lock clear button
            } else if (state === 'analyzing') {
                dot.classList.add('analyzing');
                text.textContent = 'Analyzing...';
            } else {
                dot.classList.add('ready');
                text.textContent = 'Ready';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                clearBtn.disabled = false;
            }
        }

        function showToast(icon, msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastMessage').textContent = msg;
            t.classList.add('active');
            setTimeout(() => t.classList.remove('active'), 3000);
        }

        // --- 6. EVENT BINDINGS ---
        document.getElementById('startBtn').onclick = startListening;
        document.getElementById('stopBtn').onclick = stopListening;
        
        document.getElementById('clearBtn').onclick = () => {
            if (confirm("Clear all data?")) {
                currentTemplate.forEach(f => f.value = '');
                document.getElementById('userNotesInput').value = '';
                document.getElementById('transcriptText').textContent = "Waiting for audio...";
                renderGrid();
                fullTranscript = "";
            }
        };

        // User Notes Sync
        document.getElementById('userNotesInput').addEventListener('input', () => {
            clearTimeout(syncTimer);
            syncTimer = setTimeout(syncFieldsToServer, 2000);
        });

        // Initialize
        initUI();

    </script>
</body>
</html>
