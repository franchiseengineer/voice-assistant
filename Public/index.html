<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bingo Notes</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            margin: 0; padding: 0; background: #f5f5f5; touch-action: manipulation;
        }

        /* Sticky Header */
        #app-header {
            position: sticky; top: 0; z-index: 1000; background: #fff;
            padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h1 { margin: 0; font-size: 1.3em; color: #333; }
        #settings-btn { background: none; border: none; font-size: 1.4em; padding: 5px; }

        /* Status Bar */
        #status-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em;
        }
        #status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #bbb; margin-right: 8px; }

        /* Buttons */
        .btn-group { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button {
            padding: 12px 8px; border: none; border-radius: 8px; font-size: 0.85em; font-weight: 600;
            cursor: pointer; transition: all 0.2s; touch-action: manipulation;
        }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; }

        #start-btn { background: #007bff; color: white; }
        #stop-btn { background: #6c757d; color: white; }
        #report-btn { background: #28a745; color: white; } 
        #clear-btn { background: #ffc107; color: #212529; }
        #add-field-btn { background: #17a2b8; color: white; }

        /* Content Areas */
        .content-section { background: white; margin: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
        .section-title { font-size: 1.1em; font-weight: 600; margin-bottom: 12px; color: #333; }

        /* Fields */
        .field-row { display: grid; grid-template-columns: 1fr 40px; gap: 10px; margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; }
        .field-row.updated { border: 2px solid #28a745; animation: pulse 0.5s; }
        @keyframes pulse { 0%, 100% { background: #f8f9fa; } 50% { background: #d4edda; } }

        .field-label { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .field-name { font-weight: 600; color: #495057; }
        .field-hint { font-size: 0.85em; color: #6c757d; font-style: italic; }
        .field-input { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 1em; resize: vertical; min-height: 60px; }
        .field-actions { display: flex; flex-direction: column; gap: 8px; }
        .icon-btn { width: 40px; height: 40px; background: #e9ecef; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.1em; }
        .icon-btn.locked { background: #fff3cd; color: #856404; }

        /* Transcript */
        #transcript-box {
            background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 8px 12px;
            height: 2.8em; overflow: hidden; font-size: 0.8em; line-height: 1.4; color: #495057; margin-bottom: 15px;
            display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical;
        }

        /* User Notes */
        .user-notes-container { margin-top: 25px; width: 100%; border-top: 2px dashed #ccc; padding-top: 20px; }
        .user-notes-label { color: #e67e22; font-weight: bold; display: block; margin-bottom: 8px; font-size: 1.1em; }
        .user-notes-input { width: 100%; padding: 12px; border: 2px solid #e67e22; border-radius: 6px; min-height: 100px; font-family: inherit; }

        /* Repository */
        #repo-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .note-card { background: #fff; border: 1px solid #e0e0e0; padding: 12px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .note-content { font-size: 0.9em; color: #555; margin-bottom: 12px; max-height: 120px; overflow: hidden; text-overflow: ellipsis; }
        .note-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .note-btn { font-size: 0.8em; padding: 8px; border-radius: 4px; border: none; color: white; font-weight: bold; }
        #viewHistoryBtn { background-color: #000; color: #fff; width: 100%; padding: 15px; font-size: 1em; font-weight: bold; margin-bottom: 10px; border-radius: 8px; }

    </style>
</head>
<body>
    <div id="app-header">
        <div class="header-top">
            <h1>üéôÔ∏è Bingo Notes</h1>
            <button id="settings-btn">‚öôÔ∏è</button>
        </div>
        
        <div id="status-bar">
            <div><span id="status-light"></span><span id="status-text">Ready</span></div>
            <div style="font-weight: 600; color: #007bff;">Microphone</div>
        </div>

        <div class="btn-group">
            <button id="start-btn">‚ñ∂Ô∏è Start</button>
            <button id="stop-btn" disabled>‚èπÔ∏è Stop</button>
            <button id="report-btn">üíæ Report</button>
            <button id="clear-btn">üóëÔ∏è Clear</button>
        </div>

        <div id="transcript-box">Waiting for audio...</div>
    </div>

    <div class="content-section">
        <div class="section-title">üìã Templates</div>
        <div style="display:grid; grid-template-columns: 1fr auto auto; gap:8px;">
            <select id="template-dropdown" style="padding:10px;"><option value="">-- Select Template --</option></select>
            <button id="load-template-btn" style="background:#007bff; color:white;">Load</button>
            <button id="save-template-btn" style="background:#28a745; color:white;">Save</button>
        </div>
    </div>

    <div class="content-section">
        <div class="section-title">üìù Data Fields</div>
        <div style="display:grid; gap:10px; margin-bottom:15px;">
            <input type="text" id="field-name-input" placeholder="Field Name" style="padding:10px;">
            <input type="text" id="field-hint-input" placeholder="Hint" style="padding:10px;">
            <button id="add-field-btn">+ Add Field</button>
        </div>
        <div id="fields-container"></div>
        
        <div class="user-notes-container">
            <label class="user-notes-label">User Notes</label>
            <textarea id="manualNotes" class="user-notes-input" placeholder="Bingo Notes will not change this field"></textarea>
        </div>
    </div>

    <div class="content-section" style="border-top: 4px solid #333;">
        <h3>üìö Note Repository</h3>
        <div id="repo-controls">
            <button id="shareAllBtn" style="background: #17a2b8; color: white;">üì§ Share All</button>
            <button id="clearRepoBtn" style="background: #dc3545; color: white;">üóëÔ∏è Clear All</button>
        </div>
        <button id="viewHistoryBtn">Show Saved Notes</button>
        <div id="historyContainer" style="display: none;"></div>
    </div>
    
    <script>
        // --- CONFIG ---
        let currentWsUrl = localStorage.getItem('voice_app_ws_url') || 'wss://voice-assistant-4plp.onrender.com';
        document.getElementById('settings-btn').addEventListener('click', () => {
            const url = prompt("Server URL:", currentWsUrl);
            if(url) { localStorage.setItem('voice_app_ws_url', url.trim()); currentWsUrl = url.trim(); }
        });

        // --- GLOBAL VARS ---
        let socket, audioContext, mediaStream, processor;
        let fields = [], fullTranscript = '';
        const fieldsContainer = document.getElementById('fields-container');
        const statusLight = document.getElementById('status-light');
        const transcriptBox = document.getElementById('transcript-box');

        // --- FIELDS ---
        function initDefaultFields() {
            if(fields.length===0) { addField('Name','Full Name'); addField('Date','Date'); addField('Summary','Summary'); }
        }
        function addField(name, hint) {
            const id = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            if(fields.find(f=>f.id===id)) return;
            fields.push({id,name,hint,value:'',locked:false});
            renderField(id,name,hint);
            syncFieldsToServer();
        }
        function renderField(id, name, hint) {
            const div = document.createElement('div'); div.className='field-row'; div.id=id;
            div.innerHTML = `
                <div style="display:flex; flex-direction:column;">
                    <div class="field-label"><span class="field-name">${name}</span></div>
                    <textarea class="field-input" id="input-${id}" placeholder="${hint}" oninput="updateVal('${id}',this.value)"></textarea>
                </div>
                <div class="field-actions">
                    <button class="icon-btn" onclick="toggleLock('${id}')">üîì</button>
                    <button class="icon-btn delete" onclick="delField('${id}')">üóëÔ∏è</button>
                </div>`;
            fieldsContainer.appendChild(div);
        }
        window.updateVal = (id,v) => { const f=fields.find(x=>x.id===id); if(f) f.value=v; };
        window.toggleLock = (id) => { 
            const f=fields.find(x=>x.id===id); f.locked=!f.locked;
            const btn = document.querySelector(`#${id} .icon-btn`);
            const inp = document.getElementById(`input-${id}`);
            btn.innerText = f.locked ? 'üîí' : 'üîì';
            btn.classList.toggle('locked', f.locked);
            inp.classList.toggle('locked', f.locked);
        };
        window.delField = (id) => { if(confirm('Delete?')) { fields=fields.filter(x=>x.id!==id); document.getElementById(id).remove(); } };

        // --- SYNC FIELDS ---
        function syncFieldsToServer() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const templateData = fields.map(f => ({ id: f.id, name: f.name, hint: f.hint }));
                socket.send('updateTemplate:' + JSON.stringify(templateData));
            }
        }

        // --- SMART UPDATE (DEDUPLICATION FIX) ---
        // Prevents overwriting AND prevents duplicate appending.
        function updateFieldValue(fieldId, value) {
            const field = fields.find(f => f.id === fieldId);
            if (!field || field.locked) return;

            const cleanValue = (value === null || value === 'null') ? '' : value.trim();
            if (!cleanValue) return; // Ignore empty inputs from server

            // 1. If field is currently empty, simply set it
            if (!field.value) {
                field.value = cleanValue;
            } 
            // 2. If field has data, Check for Duplicates before appending
            else {
                // Normalize for case-insensitive check
                const currentText = field.value.toLowerCase();
                const newText = cleanValue.toLowerCase();

                // Only append if the EXACT new text is NOT already inside the field
                if (!currentText.includes(newText)) {
                    field.value += " " + cleanValue; 
                }
            }

            const textarea = document.querySelector(`[data-field-id="${fieldId}"]`);
            if (textarea) {
                textarea.value = field.value;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
                
                const row = document.getElementById(fieldId);
                row.classList.add('updated');
                setTimeout(() => row.classList.remove('updated'), 1000);
            }
        }

        // --- AUDIO ---
        async function startRecording() {
            try {
                if(window.Capacitor) {
                    try { await Capacitor.Plugins.AndroidPermissions.requestPermissions({permissions:['android.permission.RECORD_AUDIO']}); } catch(e){}
                }
                mediaStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true}});
                socket = new WebSocket(currentWsUrl);
                
                socket.onopen = () => {
                    statusLight.style.background='#28a745'; document.getElementById('status-text').innerText='Recording...';
                    reconnectAttempts = 0; syncFieldsToServer();
                    audioContext = new (window.AudioContext||window.webkitAudioContext)();
                    const src = audioContext.createMediaStreamSource(mediaStream);
                    processor = audioContext.createScriptProcessor(4096,1,1);
                    processor.onaudioprocess = e => {
                        if(socket.readyState===1) {
                            const data = e.inputBuffer.getChannelData(0);
                            const pcm = new Int16Array(data.length);
                            for(let i=0;i<data.length;i++) pcm[i] = Math.max(-1,Math.min(1,data[i])) < 0 ? data[i]*0x8000 : data[i]*0x7FFF;
                            socket.send(pcm.buffer);
                        }
                    };
                    src.connect(processor); processor.connect(audioContext.destination);
                    document.getElementById('start-btn').disabled=true; document.getElementById('stop-btn').disabled=false;
                };
                
                socket.onmessage = e => {
                    const msg = JSON.parse(e.data);
                    if(msg.type==='transcript') {
                        transcriptBox.textContent = msg.text;
                        if(msg.isFinal) fullTranscript += msg.text + ' ';
                    } else if(msg.type==='templateUpdate') {
                        Object.keys(msg.data).forEach(k => updateFieldValue(k, msg.data[k]));
                    }
                };
            } catch(e) { alert('Mic Error: '+e.message); }
        }

        function stop() {
            if(processor) { processor.disconnect(); processor=null; }
            if(mediaStream) { mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; }
            if(socket) { socket.close(); socket=null; }
            statusLight.style.background='#bbb'; document.getElementById('status-text').innerText='Ready';
            document.getElementById('start-btn').disabled=false; document.getElementById('stop-btn').disabled=true;
        }

        document.getElementById('start-btn').onclick = startRecording;
        document.getElementById('stop-btn').onclick = stop;
        document.getElementById('clear-btn').onclick = () => {
            if(confirm('Clear Form?')) { 
                fields.forEach(f=>{f.value=''; document.getElementById(`input-${f.id}`).value='';});
                document.getElementById('manualNotes').value=''; fullTranscript=''; transcriptBox.innerText='Waiting...';
            }
        };

        // --- REPOSITORY SYSTEM ---
        function generateMD(note) {
            let txt = `# ${note.template}\n**Date:** ${note.date}\n\n`;
            note.fields.forEach(f => txt += `## ${f.label}\n${f.value}\n\n`);
            return txt;
        }

        document.getElementById('report-btn').onclick = () => {
            const note = {
                id: Date.now(), date: new Date().toLocaleString(),
                template: document.getElementById('template-dropdown').value || 'General',
                fields: []
            };
            fields.forEach(f => note.fields.push({label:f.name, value:f.value}));
            const userNotes = document.getElementById('manualNotes').value;
            if(userNotes) note.fields.push({label:'User Notes', value:userNotes});
            if(fullTranscript) note.fields.push({label:'Transcript', value:fullTranscript});

            const hist = JSON.parse(localStorage.getItem('bingoHist')||'[]');
            hist.unshift(note);
            localStorage.setItem('bingoHist', JSON.stringify(hist));
            
            alert('Saved to Repository! ‚úÖ');
            renderRepo();
            document.getElementById('historyContainer').style.display='block';
            document.getElementById('viewHistoryBtn').innerText='Hide Saved Notes';
            window.scrollTo(0, document.body.scrollHeight);
        };

        function renderRepo() {
            const hist = JSON.parse(localStorage.getItem('bingoHist')||'[]');
            const cont = document.getElementById('historyContainer');
            cont.innerHTML = '';
            if(hist.length===0) { cont.innerHTML='<p style="text-align:center;color:#777;">Empty</p>'; return; }
            
            hist.forEach(n => {
                const div = document.createElement('div'); div.className='note-card';
                div.innerHTML = `
                    <div class="note-header"><strong>${n.template}</strong><small>${n.date}</small></div>
                    <div class="note-content">${n.fields[0]?.value || '...'}</div>
                    <div class="note-actions">
                        <button class="note-btn" style="background:#28a745;" onclick="shareNoteNative(${n.id})">üì§ Share</button>
                        <button class="note-btn" style="background:#17a2b8;" onclick="copyNote(${n.id})">üìã Copy</button>
                        <button class="note-btn" style="background:#dc3545;" onclick="delNote(${n.id})">üóëÔ∏è Delete</button>
                    </div>`;
                cont.appendChild(div);
            });
        }

        // --- SAFE SHARING (Text Only) ---
        async function shareNoteNative(id) {
            const n = JSON.parse(localStorage.getItem('bingoHist')).find(x=>x.id===id);
            if(!n) return;
            const txt = generateMD(n);

            try {
                if (window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.Share) {
                    await Capacitor.Plugins.Share.share({
                        title: 'Bingo Note',
                        text: txt,
                        dialogTitle: 'Share Note'
                    });
                } 
                else if (navigator.share) {
                    await navigator.share({ title: 'Bingo Note', text: txt });
                }
                else {
                    throw new Error("No share supported");
                }
            } catch(e) {
                copyNote(id);
                alert("Share not supported. Copied to clipboard.");
            }
        }

        document.getElementById('shareAllBtn').onclick = async () => {
            const h = JSON.parse(localStorage.getItem('bingoHist')||'[]');
            if(!h.length) return alert('No notes.');
            let allTxt = '# Archive\n\n'; h.forEach(n => allTxt += generateMD(n) + '\n---\n');
            
            try {
                if (window.Capacitor && Capacitor.Plugins && Capacitor.Plugins.Share) {
                    await Capacitor.Plugins.Share.share({ title: 'Archive', text: allTxt, dialogTitle: 'Share Archive' });
                } else if(navigator.share) {
                    await navigator.share({title:'Archive', text:allTxt});
                } else { throw new Error("No Share"); }
            } catch(e) {
                navigator.clipboard.writeText(allTxt); alert('Copied all to clipboard.');
            }
        };

        window.copyNote = (id) => {
            const n = JSON.parse(localStorage.getItem('bingoHist')).find(x=>x.id===id);
            navigator.clipboard.writeText(generateMD(n));
            alert('Copied! üìã');
        };

        window.delNote = (id) => {
            if(confirm('Delete?')) {
                const h = JSON.parse(localStorage.getItem('bingoHist')).filter(x=>x.id!==id);
                localStorage.setItem('bingoHist', JSON.stringify(h)); renderRepo();
            }
        };

        document.getElementById('clearRepoBtn').onclick = () => {
            if(confirm('Delete ALL history?')) { localStorage.removeItem('bingoHist'); renderRepo(); }
        };

        document.getElementById('viewHistoryBtn').onclick = function() {
            const c = document.getElementById('historyContainer');
            c.style.display = c.style.display==='none'?'block':'none';
            this.innerText = c.style.display==='block'?'Hide Saved Notes':'Show Saved Notes';
            renderRepo();
        };

        document.getElementById('add-field-btn').onclick = () => {
            const n = document.getElementById('field-name-input');
            const h = document.getElementById('field-hint-input');
            if(n.value) { addField(n.value, h.value||'Hint'); n.value=''; h.value=''; }
        };

        // ... Template Buttons ...
        document.getElementById('save-template-btn').addEventListener('click', () => {
            const name = prompt('Template Name:'); if(!name) return;
            const t = JSON.parse(localStorage.getItem('voice_templates')||'{}');
            t[name] = fields.map(f=>({name:f.name,hint:f.hint}));
            localStorage.setItem('voice_templates',JSON.stringify(t));
            updateTemplateDropdown();
        });
        document.getElementById('load-template-btn').addEventListener('click', () => {
            const name = templateDropdown.value; if(!name) return;
            const t = JSON.parse(localStorage.getItem('voice_templates')||'{}')[name];
            if(t) { fields=[]; fieldsContainer.innerHTML=''; t.forEach(f=>addField(f.name,f.hint)); }
        });
        
        function updateTemplateDropdown() {
            const t = JSON.parse(localStorage.getItem('voice_templates')||'{}');
            templateDropdown.innerHTML = '<option value="">-- Select Template --</option>';
            Object.keys(t).forEach(n => {
                const o = document.createElement('option'); o.value=n; o.innerText=n; templateDropdown.appendChild(o);
            });
        }

        initDefaultFields(); renderRepo(); updateTemplateDropdown();
    </script>
</body>
</html>
